<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üìÑ Multi-File RAG Chatbot</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    input, button, textarea, select { padding: 8px; font-size: 16px; }
    textarea { width: 100%; min-height: 100px; font-family: Arial; }
    #chat-box { margin-top: 20px; max-width: 700px; }
    .user, .bot { margin: 10px 0; }
    .user { font-weight: bold; }
    .bot { color: green; white-space: pre-wrap; }
    .loading { color: #999; font-style: italic; }
    .success { color: green; background: #f0f8f0; padding: 10px; border-radius: 5px; margin: 10px 0; }
    .error { color: red; background: #fff0f0; padding: 10px; border-radius: 5px; margin: 10px 0; }
    .documents-status { background: #f0f8ff; padding: 15px; border-radius: 5px; margin: 15px 0; }
    .document-item { background: #f9f9f9; padding: 10px; margin: 5px 0; border-radius: 3px; cursor: pointer; border-left: 4px solid #ddd; }
    .document-item.active { border-left-color: #4CAF50; background: #f0fff0; }
    .document-item:hover { background: #f0f0f0; }
    .processing-results { background: #f9f9f9; padding: 10px; border-radius: 5px; margin: 10px 0; font-family: monospace; font-size: 14px; white-space: pre-line; }
    .form-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
    .url-examples { font-size: 12px; color: #666; font-style: italic; margin-top: 5px; }
    .search-options { margin: 10px 0; }
    .stats { display: flex; gap: 20px; margin: 10px 0; }
    .stat { text-align: center; padding: 10px; background: #e8f4f8; border-radius: 5px; }
    .stat-number { font-size: 24px; font-weight: bold; display: block; }
    .stat-label { font-size: 12px; color: #666; }
  </style>
</head>
<body>
  <h2>üß† Multi-File RAG Chatbot</h2>

  <!-- Show documents status if any are loaded -->
  {% if documents_collection and documents_collection.documents %}
    <div class="documents-status">
      <h3>üìÇ Loaded Documents</h3>
      
      <div class="stats">
        <div class="stat">
          <span class="stat-number">{{ documents_collection.documents|length }}</span>
          <span class="stat-label">Documents</span>
        </div>
        <div class="stat">
          <span class="stat-number">{{ documents_collection.total_chunks }}</span>
          <span class="stat-label">Text Chunks</span>
        </div>
        <div class="stat">
          <span class="stat-number">{{ documents_collection.total_tables }}</span>
          <span class="stat-label">Tables</span>
        </div>
      </div>

      <div class="documents-list">
        {% for doc in documents_collection.documents %}
        <div class="document-item {% if loop.index0 == documents_collection.current_index %}active{% endif %}" 
             onclick="switchDocument({{ loop.index0 }})">
          <strong>{{ loop.index }}. {{ doc.filename }}</strong>
          <span style="float: right;">
            {% if doc.type == 'table' %}
              üìä Table ({{ doc.content.shape[0] }}√ó{{ doc.content.shape[1] }})
            {% else %}
              üìÑ Text ({{ doc.chunks|length }} chunks)
            {% endif %}
          </span>
          {% if loop.index0 == documents_collection.current_index %}
            <div style="color: #4CAF50; font-size: 12px; margin-top: 5px;">‚úì Currently active</div>
          {% endif %}
        </div>
        {% endfor %}
      </div>

      <button onclick="clearDocuments()" style="background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 3px; cursor: pointer; margin-top: 10px;">
        üóëÔ∏è Clear All Documents
      </button>
    </div>

    <!-- Chat Interface -->
    <div id="chat-box"></div>
    
    <div class="search-options">
      <label>Search in:</label>
      <select id="search-mode">
        <option value="current">Current Document Only</option>
        <option value="all">All Documents</option>
        {% for doc in documents_collection.documents %}
        <option value="{{ loop.index0 }}">{{ loop.index }}. {{ doc.filename }}</option>
        {% endfor %}
      </select>
    </div>

    <input type="text" id="question" placeholder="Ask something..." style="width: 70%;" />
    <button onclick="ask()">Ask</button>

  {% endif %}

  <!-- File Upload Section -->
  <div class="form-section">
    <h3>üìÅ Add More Documents</h3>
    <form method="post" enctype="multipart/form-data">
      
      <!-- Multiple URLs Input -->
      <label>üîó Enter Multiple URLs (one per line):</label><br />
      <textarea name="file_urls" placeholder="https://example.com/file1.pdf
https://example.com/file2.docx
https://example.com/file3.csv"></textarea>
      <div class="url-examples">
        Examples: Google Drive public links, Dropbox public links, direct file URLs
      </div>
      <br />

      <!-- Single URL Input (for backward compatibility) -->
      <label>üîó Or Enter Single URL:</label><br />
      <input type="text" name="file_url" size="80" placeholder="https://example.com/document.pdf" /><br /><br />

      <!-- File Upload -->
      <label>üìé Or Upload File:</label><br />
      <input type="file" name="file" /><br /><br />

      <button type="submit">Process Files</button>
    </form>
  </div>

  <!-- Messages -->
  {% if success %}
    <div class="success">
      <p>‚úÖ {{ message }}</p>
      {% if processing_results %}
        <div class="processing-results">{{ processing_results | join('\n') }}</div>
      {% endif %}
    </div>
  {% endif %}

  {% if error %}
    <div class="error">{{ error }}</div>
  {% endif %}

  <script>
    function ask() {
      const question = document.getElementById("question").value;
      const searchMode = document.getElementById("search-mode").value;
      const chatBox = document.getElementById("chat-box");

      if (!question.trim()) return;

      chatBox.innerHTML += `<div class='user'>You: ${question}</div>`;
      chatBox.innerHTML += `<div id="loading" class='loading'>Bot is thinking...</div>`;

      fetch("/ask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ 
          question: question,
          search_mode: searchMode 
        })
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById("loading").remove();
        chatBox.innerHTML += `<div class='bot'>Bot: ${data.answer}</div>`;
        document.getElementById("question").value = "";
        chatBox.scrollTop = chatBox.scrollHeight;
      })
      .catch(error => {
        document.getElementById("loading").remove();
        chatBox.innerHTML += `<div class='bot'>Bot: Error getting response - ${error.message}</div>`;
      });
    }

    function switchDocument(index) {
      fetch("/switch_document", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ index: index })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          location.reload(); // Refresh to update the active document display
        } else {
          alert("Error: " + data.error);
        }
      })
      .catch(error => {
        alert("Error switching document: " + error.message);
      });
    }

    function clearDocuments() {
      if (confirm("Are you sure you want to clear all documents?")) {
        fetch("/clear_documents", {
          method: "POST",
          headers: { "Content-Type": "application/json" }
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            location.reload(); // Refresh the page
          } else {
            alert("Error: " + data.error);
          }
        })
        .catch(error => {
          alert("Error clearing documents: " + error.message);
        });
      }
    }

    // Allow pressing Enter to ask question
    document.getElementById("question").addEventListener("keypress", function(event) {
      if (event.key === "Enter") {
        ask();
      }
    });

    // Auto-scroll chat to bottom
    function scrollChatToBottom() {
      const chatBox = document.getElementById("chat-box");
      if (chatBox) {
        chatBox.scrollTop = chatBox.scrollHeight;
      }
    }

    // Scroll to bottom when page loads
    window.onload = function() {
      scrollChatToBottom();
    };
  </script>
</body>
</html>